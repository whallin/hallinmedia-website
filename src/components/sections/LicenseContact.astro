---
import { Icon } from "astro-icon/components";
import { getRelativeLocaleUrl } from "astro:i18n";
import Button from "../common/Button.astro";

const translations = {
  en: {
    title: "Contact me about licensing",
    titleSr: "Contact information",
    name: "Name",
    email: "Email",
    emailPlaceholder: "your@email.com",
    licenseTypeSr: "License information",
    licenseType: "License type",
    selectLicense: "Select license type",
    standardLicense: "Standard license",
    extendedLicense: "Extended license",
    exclusiveLicense: "Exclusive license",
    customLicense: "Custom license",
    message: "Message",
    messagePlaceholder: "Describe your licensing needs...",
    submit: "Send licensing request",
    relatedDocuments: "Related legal documents",
    documentDescription: "For comprehensive information, please see the relevant legal documents:",
    licensingAgreement: "Licensing agreement",
    copyrightMessage: "Copyright notice",
    publishingGuidelines: "Publishing guidelines",
    creditGuidelines: "Credit guidelines",
    sending: "Sending...",
    success: "Message sent! I'll reply soon.",
    error: "Error sending message. Try again.",
  },
  sv: {
    title: "Kontakta mig om licensiering",
    titleSr: "Kontaktinformation",
    name: "Namn",
    email: "E-post",
    emailPlaceholder: "din@e-post.se",
    licenseTypeSr: "Licensinformation",
    licenseType: "Licenstyp",
    selectLicense: "Välj licenstyp",
    standardLicense: "Standardlicens",
    extendedLicense: "Utökad licens",
    exclusiveLicense: "Exklusiv licens",
    customLicense: "Anpassad licens",
    message: "Meddelande",
    messagePlaceholder: "Beskriv dina licensbehov...",
    submit: "Skicka licensförfrågan",
    relatedDocuments: "Relaterade juridiska dokument",
    documentDescription: "För omfattande information, vänligen se det relevanta juridiska dokumenten:",
    licensingAgreement: "Licensavtal",
    copyrightMessage: "Upphovsrättsmeddelande",
    publishingGuidelines: "Publiceringsriktlinjer",
    creditGuidelines: "Krediteringsriktlinjer",
    sending: "Skickar...",
    success: "Meddelandet skickat! Jag svarar snart.",
    error: "Fel vid skickande. Försök igen.",
  },
};

const locale = Astro.currentLocale === "en" || Astro.currentLocale === "sv" ? Astro.currentLocale : "en";
---

<article class="space-y-6" aria-labelledby="contact-heading">
  <h2 id="contact-heading" class="relative font-serif text-lg text-stone-700 dark:text-stone-100">
    <span class="relative z-10 inline-flex flex-col gap-2 bg-amber-50 pr-4 dark:bg-stone-900">
      {translations[locale].title}
    </span>
    <span class="absolute top-1/2 right-0 left-0 -z-0 h-px bg-stone-200 dark:bg-stone-700" aria-hidden="true"></span>
  </h2>
  <div class="rounded-lg border border-stone-200 bg-amber-50 p-6 dark:border-stone-700 dark:bg-stone-900">
    <form
      id="licensing-contact-form"
      class="space-y-6"
      action="/api/contact/licensing"
      method="POST"
      aria-labelledby="form-heading"
    >
      <h3 id="form-heading" class="sr-only">{translations[locale].title}</h3>
      <fieldset class="grid gap-6 sm:grid-cols-2">
        <legend class="sr-only">{translations[locale].titleSr}</legend>
        <div class="form-group">
          <label for="name" class="font-serif text-sm text-stone-600 dark:text-stone-400">
            <Icon name="ph:user-circle-duotone" class="-mt-1 inline-block h-4 w-4 text-red-500" aria-hidden="true" />
            {translations[locale].name}
            <span class="ml-0.5 text-red-500" aria-hidden="true">*</span>
          </label>
          <input
            type="text"
            name="name"
            id="name"
            required
            class="mt-1 w-full rounded-md border border-stone-200 bg-amber-100/25 px-3 py-2 text-stone-900 placeholder-stone-400 focus:border-red-500 focus:ring-red-500 focus:outline-none dark:border-stone-700 dark:bg-stone-900 dark:text-stone-100 dark:placeholder-stone-500"
            placeholder="William Hallin"
          />
        </div>
        <div class="form-group">
          <label for="email" class="font-serif text-sm text-stone-600 dark:text-stone-400">
            <Icon name="ph:envelope-duotone" class="-mt-1 inline-block h-4 w-4 text-red-500" aria-hidden="true" />
            {translations[locale].email}
            <span class="ml-0.5 text-red-500" aria-hidden="true">*</span>
          </label>
          <input
            type="email"
            name="email"
            id="email"
            required
            class="mt-1 w-full rounded-md border border-stone-200 bg-amber-100/25 px-3 py-2 text-stone-900 placeholder-stone-400 focus:border-red-500 focus:ring-red-500 focus:outline-none dark:border-stone-700 dark:bg-stone-900 dark:text-stone-100 dark:placeholder-stone-500"
            placeholder={translations[locale].emailPlaceholder}
          />
        </div>
      </fieldset>
      <fieldset>
        <legend class="sr-only">{translations[locale].licenseTypeSr}</legend>
        <div class="space-y-6">
          <div class="form-group">
            <label for="licenseType" class="font-serif text-sm text-stone-600 dark:text-stone-400">
              <Icon name="ph:certificate-duotone" class="-mt-1 inline-block h-4 w-4 text-red-500" aria-hidden="true" />
              {translations[locale].licenseType}
              <span class="ml-0.5 text-red-500" aria-hidden="true">*</span>
            </label>
            <select
              id="licenseType"
              name="licenseType"
              required
              class="mt-1 w-full rounded-md border border-stone-200 bg-amber-100/25 px-3 py-2 text-stone-900 focus:border-red-500 focus:ring-red-500 focus:outline-none dark:border-stone-700 dark:bg-stone-900 dark:text-stone-100"
            >
              <option value="">{translations[locale].selectLicense}</option>
              <option value="standard">{translations[locale].standardLicense}</option>
              <option value="extended">{translations[locale].extendedLicense}</option>
              <option value="exclusive">{translations[locale].exclusiveLicense}</option>
              <option value="custom">{translations[locale].customLicense}</option>
            </select>
          </div>
          <div class="form-group">
            <label for="message" class="font-serif text-sm text-stone-600 dark:text-stone-400">
              <Icon
                name="ph:chat-circle-dots-duotone"
                class="-mt-1 inline-block h-4 w-4 text-red-500"
                aria-hidden="true"
              />
              {translations[locale].message}
              <span class="ml-0.5 text-red-500" aria-hidden="true">*</span>
            </label>
            <textarea
              id="message"
              name="message"
              rows="4"
              required
              class="mt-1 w-full rounded-md border border-stone-200 bg-amber-100/25 px-3 py-2 text-stone-900 placeholder-stone-400 focus:border-red-500 focus:ring-red-500 focus:outline-none dark:border-stone-700 dark:bg-stone-900 dark:text-stone-100 dark:placeholder-stone-500"
              placeholder={translations[locale].messagePlaceholder}></textarea>
          </div>
        </div>
      </fieldset>
      <Button type="submit" id="submit-button">
        <Icon name="ph:paper-plane-right-duotone" class="flex-shrink-0" aria-hidden="true" />
        <span id="button-text">{translations[locale].submit}</span>
      </Button>
    </form>
  </div>
  <aside
    class="rounded-lg border border-stone-200 bg-amber-50 p-6 dark:border-stone-700 dark:bg-stone-800"
    aria-labelledby="related-docs-heading"
  >
    <div class="flex items-center gap-2">
      <Icon name="ph:file-duotone" class="h-6 w-6 flex-shrink-0 text-red-500" aria-hidden="true" />
      <h3 id="related-docs-heading" class="font-serif font-medium text-stone-700 dark:text-stone-100">
        {translations[locale].relatedDocuments}
      </h3>
    </div>
    <p class="mt-3 font-serif text-stone-500 dark:text-stone-400">
      {translations[locale].documentDescription}
    </p>
    <div class="mt-4 grid gap-3 sm:grid-cols-2">
      <a
        href={getRelativeLocaleUrl(locale, "legal/licensing-agreement")}
        class="flex w-fit items-center gap-2 font-serif text-red-500 underline decoration-dashed decoration-from-font underline-offset-4 hover:bg-red-500 hover:text-stone-100 active:opacity-50"
      >
        <Icon name="ph:image-duotone" class="h-4 w-4 flex-shrink-0" aria-hidden="true" />
        <span>{translations[locale].licensingAgreement}</span>
      </a>
      <a
        href={getRelativeLocaleUrl(locale, "legal/copyright-notice")}
        class="flex w-fit items-center gap-2 font-serif text-red-500 underline decoration-dashed decoration-from-font underline-offset-4 hover:bg-red-500 hover:text-stone-100 active:opacity-50"
      >
        <Icon name="ph:copyright-duotone" class="h-4 w-4 flex-shrink-0" aria-hidden="true" />
        <span>{translations[locale].copyrightMessage}</span>
      </a>
      <a
        href={getRelativeLocaleUrl(locale, "legal/publishing-guidelines")}
        class="flex w-fit items-center gap-2 font-serif text-red-500 underline decoration-dashed decoration-from-font underline-offset-4 hover:bg-red-500 hover:text-stone-100 active:opacity-50"
      >
        <Icon name="ph:file-text-duotone" class="h-4 w-4 flex-shrink-0" aria-hidden="true" />
        <span>{translations[locale].publishingGuidelines}</span>
      </a>
      <a
        href={getRelativeLocaleUrl(locale, "legal/credit-guidelines")}
        class="flex w-fit items-center gap-2 font-serif text-red-500 underline decoration-dashed decoration-from-font underline-offset-4 hover:bg-red-500 hover:text-stone-100 active:opacity-50"
      >
        <Icon name="ph:info-duotone" class="h-4 w-4 flex-shrink-0" aria-hidden="true" />
        <span>{translations[locale].creditGuidelines}</span>
      </a>
    </div>
  </aside>
</article>

<script define:vars={{ translations, locale }}>
  const form = document.getElementById("licensing-contact-form");
  const submitButton = document.getElementById("submit-button");
  const buttonText = document.getElementById("button-text");

  function updateButtonState(state, isDisabled = true) {
    if (!submitButton || !buttonText) return;

    const states = {
      default: { text: translations[locale].submit, class: "bg-red-500" },
      loading: { text: translations[locale].sending, class: "bg-stone-500" },
      success: { text: translations[locale].success, class: "bg-green-500" },
      error: { text: translations[locale].error, class: "bg-amber-500" },
    };

    submitButton.disabled = isDisabled;
    buttonText.textContent = states[state].text;
    submitButton.className = submitButton.className.replace(/bg-\w+-500/g, states[state].class);

    if (isDisabled) {
      submitButton.classList.add("pointer-events-none");
    } else {
      submitButton.classList.remove("pointer-events-none");
    }
  }

  if (form) {
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      try {
        updateButtonState("loading");
        const formData = new FormData(form);
        const jsonData = Object.fromEntries(formData);

        const response = await fetch("/api/contact/licensing", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(jsonData),
        });

        if (response.ok) {
          updateButtonState("success");
          form.reset();
        } else {
          throw new Error("Submission failed");
        }
      } catch {
        updateButtonState("error");
      } finally {
        setTimeout(() => updateButtonState("default", false), 3000);
      }
    });
  }
</script>
