---
import { Picture } from "astro:assets";
import { getCollection, render, type CollectionEntry } from "astro:content";
import { getRelativeLocaleUrl } from "astro:i18n";
import BlogHeader from "../../components/blog/BlogHeader.astro";
import BlogMeta from "../../components/blog/BlogMeta.astro";
import RelatedPosts from "../../components/blog/RelatedPosts.astro";
import CtaBanner from "../../components/sections/CtaBanner.astro";
import MainLayout from "../../layouts/MainLayout.astro";

export async function getStaticPaths() {
  const blogPosts = await getCollection("blogEnCollection");
  return blogPosts.map((post) => ({
    params: { slug: post.id },
    props: { post, allPosts: blogPosts },
  }));
}

type Props = {
  post: CollectionEntry<"blogEnCollection">;
  allPosts: CollectionEntry<"blogEnCollection">[];
};

const { post, allPosts } = Astro.props;
const { Content, remarkPluginFrontmatter } = await render(post);
const categoryColor = {
  Design: "sky",
  Photography: "fuchsia",
  Video: "rose",
  Marketing: "emerald",
  Technology: "amber",
  Business: "indigo",
  Tutorials: "pink",
  Insights: "teal",
}[post.data.category];

const categoryStyles = {
  Design: "hover:border-sky-500",
  Photography: "hover:border-fuchsia-500",
  Video: "hover:border-rose-500",
  Marketing: "hover:border-emerald-500",
  Technology: "hover:border-amber-500",
  Business: "hover:border-indigo-500",
  Tutorials: "hover:border-pink-500",
  Insights: "hover:border-teal-500",
}[post.data.category];
---

<MainLayout
  title={post.data.title}
  description={post.data.description}
  article={true}
  datePublished={post.data.publishedDate}
  dateModified={post.data.updatedDate}
>
  <article class="flex flex-col gap-8 font-serif" aria-labelledby="article-title">
    <BlogHeader
      category={post.data.category}
      title={post.data.title}
      categoryColor={categoryColor}
      id="article-title"
    />

    {
      post.data.featuredImage && (
        <Picture
          src={post.data.featuredImage}
          alt={post.data.featuredImageAlt || "Featured image for the article"}
          widths={[320, 480, 640, 768, 1024, 1280]}
          formats={["avif", "webp", "jpeg"]}
          sizes="(max-width: 640px) 100vw, (max-width: 1024px) 80vw, 60vw"
          class={`aspect-video w-full rounded-lg border-2 border-stone-300 object-cover transition select-none hover:-translate-y-1 hover:drop-shadow-lg ${categoryStyles}`}
          aria-describedby="image-description"
        />
      )
    }

    <BlogMeta
      publishedDate={post.data.publishedDate}
      updatedDate={post.data.updatedDate}
      author={post.data.author}
      readingTime={Math.ceil(remarkPluginFrontmatter.readingTime)}
      tags={post.data.tags}
      categoryColor={categoryColor}
    />

    <section
      class="prose prose-stone prose-a:text-red-500 prose-a:underline prose-a:decoration-dashed prose-a:decoration-from-font prose-a:underline-offset-4 prose-a:hover:bg-red-500 prose-a:hover:text-stone-50 prose-a:active:opacity-75 my-8 max-w-none text-sm font-light text-stone-700 selection:bg-red-300 selection:text-red-800"
      aria-label="Article content"
    >
      <Content />
    </section>

    <hr class="border-stone-300" aria-hidden="true" />

    <script
      is:inline
      src="https://giscus.app/client.js"
      data-repo="whallin/hallinmedia-website"
      data-repo-id="R_kgDOKc4lgw"
      data-category="Giscus Comments"
      data-category-id="DIC_kwDOKc4lg84Ca-9R"
      data-mapping="pathname"
      data-strict="0"
      data-reactions-enabled="0"
      data-emit-metadata="0"
      data-input-position="bottom"
      data-theme="gruvbox_light"
      data-lang="en"
      data-loading="lazy"
      crossorigin="anonymous"
      async></script>

    <hr class="border-stone-300" aria-hidden="true" />

    {
      post.data.relatedPosts && post.data.relatedPosts.length > 0 && (
        <RelatedPosts
          postId={post.id}
          relatedPosts={post.data.relatedPosts}
          allPosts={allPosts}
          categoryColor={categoryColor}
          currentLocale={Astro.currentLocale}
        />
      )
    }

    <CtaBanner
      title="Enjoyed this post?"
      description={`If you found this article helpful or interesting, consider sharing it with others who might benefit from it. You can also explore more content in the ${post.data.category} category.`}
      buttonText={`More ${post.data.category} posts`}
      pricingText="Share on LinkedIn"
      contactLink={getRelativeLocaleUrl(
        `${Astro.currentLocale}`,
        `/blog?category=${post.data.category.toLowerCase()}`
      )}
      pricingLink={`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(Astro.url.href)}`}
    />
  </article>
</MainLayout>
